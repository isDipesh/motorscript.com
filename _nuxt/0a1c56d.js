(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{170:function(e,t,n){"use strict";var o={props:["title","published","updated","archived"],head:function(){return{title:this.title}}},r=n(8),component=Object(r.a)(o,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("h1",{staticClass:"title",attrs:{itemprop:"name headline"}},[e._v(e._s(e.title))]),e._v(" "),n("div",{staticClass:"time"},[e._v("Published: "),n("time",{attrs:{itemprop:"datePublished"}},[e._v(e._s(e.published))])]),e._v(" "),e.updated?n("div",{staticClass:"time"},[e._v("Updated: "),n("time",{attrs:{itemprop:"dateModified"}},[e._v(e._s(e.updated))])]):e._e(),e._v(" "),e.archived?n("div",{staticClass:"block"},[e._v("Note: This is an archived post. Information may not be relevant now.")]):e._e()])}),[],!1,null,null,null);t.a=component.exports},177:function(e,t,n){"use strict";n.r(t);n(23);var o=n(170);var r={mixins:[o.a],components:{BlogTitle:o.a},data:function(){return{bucket_name:"bucket_name",region:"ap-south-1",access_id:"aws_access_key_id",access_key:"aws_secret_access_key",version:"9.6"}},methods:{download:function(){var element=document.createElement("a"),content=function(form){for(var e={},t=form.querySelectorAll("input, select, textarea"),i=0;i<t.length;++i){var element=t[i],n=element.name,o=element.value;n&&(e[n]=o)}return JSON.stringify(e)}(document.getElementById("django-form"));element.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(content)),element.setAttribute("download",this.bucket_name+".json"),element.style.display="none",document.body.appendChild(element),element.click(),document.body.removeChild(element)}}},c=n(8),component=Object(c.a)(r,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("article",{attrs:{itemprop:"blogPost",itemscope:"",itemtype:"https://schema.org/BlogPosting"}},[n("BlogTitle",{attrs:{title:"Automatic Continuous PostgreSQL Backup with Wal-e",published:"04 Apr 2018"}}),e._v(" "),n("div",{directives:[{name:"highlight",rawName:"v-highlight"}],staticClass:"content",attrs:{itemprop:"articleBody"}},[n("h3",[e._v("Create AWS S3 IAM user and a bucket")]),e._v(" "),e._m(0),e._v(" "),n("div",{staticClass:"block"},[n("ul",[n("form",{attrs:{id:"django-form"}},[n("div",{staticClass:"right btn small",on:{click:e.download}},[e._v("\n              Download form data\n            ")]),e._v(" "),n("li",[e._v("\n              S3 Bucket Name:\n              "),n("input",{directives:[{name:"model",rawName:"v-model",value:e.bucket_name,expression:"bucket_name"}],attrs:{name:"s3_bucket_name"},domProps:{value:e.bucket_name},on:{input:function(t){t.target.composing||(e.bucket_name=t.target.value)}}})]),e._v(" "),n("li",[e._v("AWS Region: "),n("input",{directives:[{name:"model",rawName:"v-model",value:e.region,expression:"region"}],attrs:{name:"aws_region"},domProps:{value:e.region},on:{input:function(t){t.target.composing||(e.region=t.target.value)}}})]),e._v(" "),n("li",[e._v("\n              AWS Access Key ID :\n              "),n("input",{directives:[{name:"model",rawName:"v-model",value:e.access_id,expression:"access_id"}],attrs:{name:"aws_access_key_id"},domProps:{value:e.access_id},on:{input:function(t){t.target.composing||(e.access_id=t.target.value)}}})]),e._v(" "),n("li",[e._v("\n              AWS Access Secret Key :\n              "),n("input",{directives:[{name:"model",rawName:"v-model",value:e.access_key,expression:"access_key"}],attrs:{name:"aws_access_secret_key"},domProps:{value:e.access_key},on:{input:function(t){t.target.composing||(e.access_key=t.target.value)}}})]),e._v(" "),n("li",[e._v("\n              PostgreSQL Version :\n              "),n("input",{directives:[{name:"model",rawName:"v-model",value:e.version,expression:"version"}],attrs:{name:"postgresql_version"},domProps:{value:e.version},on:{input:function(t){t.target.composing||(e.version=t.target.value)}}})])])])]),e._v(" "),e._m(1),e._v(" "),e._m(2),e._v("\n\n      Install "),n("code",[e._v("pip")]),e._v(" if necessary.\n      "),e._m(3),e._v("\n\n      Install wal-e\n      "),e._m(4),e._v(" "),n("h3",[e._v("Configure backing up of WAL segments")]),e._v(" "),n("pre",{staticClass:"language-bash command-line",attrs:{"data-prompt":"$"}},[n("code",[e._v("sudo mkdir -p /etc/wal-e.d/env\necho 's3://"+e._s(e.bucket_name)+"/' | sudo tee /etc/wal-e.d/env/WALE_S3_PREFIX\necho '"+e._s(e.region)+"' | sudo tee /etc/wal-e.d/env/AWS_REGION\necho '"+e._s(e.access_id)+"' | sudo tee /etc/wal-e.d/env/AWS_ACCESS_KEY_ID\necho '"+e._s(e.access_key)+"' | sudo tee /etc/wal-e.d/env/AWS_SECRET_ACCESS_KEY")])]),e._v(" "),n("h3",[e._v("Configure base backup")]),e._v(" "),n("pre",{staticClass:"language-bash command-line",attrs:{"data-prompt":"$"}},[n("code",[e._v("POSTGRES_VERSION="+e._s(e.version)+'\necho -e "\\n# Backup settings for WAL-E" | sudo tee -a /etc/postgresql/${POSTGRES_VERSION}/main/postgresql.conf\necho -e "wal_level = replica" | sudo tee -a /etc/postgresql/${POSTGRES_VERSION}/main/postgresql.conf\necho -e "archive_mode = on" | sudo tee -a /etc/postgresql/${POSTGRES_VERSION}/main/postgresql.conf\necho -e "archive_command = \'envdir /etc/wal-e.d/env /usr/local/bin/wal-e wal-push %p\'" | sudo tee -a /etc/postgresql/${POSTGRES_VERSION}/main/postgresql.conf\necho -e "archive_timeout = 60" | sudo tee -a /etc/postgresql/${POSTGRES_VERSION}/main/postgresql.conf')])]),e._v("\n\n      Add cronjob for nightly base backup\n      "),n("pre",{staticClass:"language-bash command-line",attrs:{"data-prompt":"$"}},[n("code",[e._v('crontab -l | { cat; echo "0 0 * * * /usr/bin/envdir /etc/wal-e.d/env /usr/local/bin/wal-e backup-push /var/lib/postgresql/'+e._s(e.version)+'/main"; } | crontab -')])]),e._v(" "),n("h3",[e._v("Restoring from backup")]),e._v(" "),n("pre",{staticClass:"language-bash command-line",attrs:{"data-prompt":"$","data-output":"4,8,13,15"}},[n("code",[e._v("POSTGRES_VERSION="+e._s(e.version)+"\nsudo systemctl stop postgresql\nsudo mv /var/lib/postgresql/${POSTGRES_VERSION}/main /var/lib/postgresql/${POSTGRES_VERSION}/main_old\n\nsu postgres\nPOSTGRES_VERSION="+e._s(e.version)+"\nenvdir /etc/wal-e.d/env /usr/local/bin/wal-e backup-fetch /var/lib/postgresql/${POSTGRES_VERSION}/main LATEST\n\nvi /var/lib/postgresql/${POSTGRES_VERSION}/main/recovery.conf\nrestore_command = 'envdir /etc/wal-e.d/env /usr/local/bin/wal-e wal-fetch \"%f\" \"%p\"'\n#Optionally add recovery point in time\n#recovery_target_time = '2017-04-01 03:07:00'\n\nexit\n\nsudo systemctl start potgresql")])])])],1)}),[function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ol",[n("li",[e._v("\n          Create IAM User with with Programmatic Access ["),n("a",{attrs:{href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html#id_users_create_console",target:"_blank",rel:"noopener noreferrer"}},[e._v("AWS Doc")]),e._v("]\n        ")]),e._v(" "),n("li",[e._v("\n          Create new group with\n          "),n("span",{staticClass:"hl"},[e._v("AmazonS3FullAccess")]),e._v(" policy for the user\n        ")]),e._v(" "),n("li",[e._v("\n          Obtain Access Key and Secret for the user ["),n("a",{attrs:{href:"https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html#Using_CreateAccessKey",target:"_blank",rel:"noopener noreferrer"}},[e._v("AWS Doc")]),e._v("]\n        ")]),e._v(" "),n("li",[e._v("\n          Create a Bucket ["),n("a",{attrs:{href:"https://docs.aws.amazon.com/AmazonS3/latest/gsg/CreatingABucket.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("AWS Doc")]),e._v("]\n        ")])])},function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("h3",[e._v("Install "),n("code",[e._v("wal-e")]),e._v(" on server")])},function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"block"},[e._v("\n        Note: wal-e doesn't work with Python 3.6 as of now. ["),n("a",{attrs:{href:"https://github.com/wal-e/wal-e/issues/322",target:"_blank",rel:"noopener noreferrer"}},[e._v("Issue")]),e._v("]\n      ")])},function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("pre",{staticClass:"language-bash command-line",attrs:{"data-prompt":"$"}},[n("code",[e._v("wget https://bootstrap.pypa.io/get-pip.py\nsudo python3 get-pip.py")])])},function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("pre",{staticClass:"language-bash command-line",attrs:{"data-prompt":"$"}},[n("code",[e._v("sudo apt install daemontools lzop pv\nsudo pip3 install 'wal-e[aws]'")])])}],!1,null,null,null);t.default=component.exports}}]);